name: Auto-Update Documentation

on:
  repository_dispatch:
    types: [source-pr-merged]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Claude Code CLI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.client_payload.pr_number }}
          PR_TITLE: ${{ github.event.client_payload.pr_title }}
          PR_URL: ${{ github.event.client_payload.pr_url }}
          PR_BODY: ${{ github.event.client_payload.pr_body }}
        run: |
          PROMPT=$(cat <<'PROMPT_END'
          A PR was just merged to the node-banana repository. Your task is to update this documentation site accordingly.

          ## Merged PR Details
          - PR #${PR_NUMBER}: ${PR_TITLE}
          - URL: ${PR_URL}
          - Description: ${PR_BODY}

          ## Instructions
          1. Analyze the PR title and description to understand what changed
          2. Determine if documentation updates are needed based on:
             - New features → add to relevant guide pages + changelog
             - Bug fixes → changelog only
             - Breaking changes → update affected pages + changelog
             - Internal/CI/API changes → no docs update needed

          3. Update the changelog at pages/changelog.mdx:
             - Add entry under Unreleased section
             - Follow the existing format (Added/Changed/Fixed/Removed)
             - Include PR number as reference

          4. If relevant pages need updates, modify them following existing patterns

          5. After making changes, create a PR using gh CLI:
             - Create branch: docs/pr-${PR_NUMBER}
             - Commit changes
             - Push and create PR with title: docs: update for PR #${PR_NUMBER}

          6. If no documentation updates are needed (e.g., internal refactoring, CI changes, API changes),
             report that no updates were necessary and do not create a PR.
          PROMPT_END
          )

          # Substitute environment variables
          PROMPT=$(echo "$PROMPT" | envsubst)

          npx @anthropic-ai/claude-code --print --dangerously-skip-permissions --allowedTools "Bash,Read,Write,Edit,Glob,Grep" "$PROMPT"
