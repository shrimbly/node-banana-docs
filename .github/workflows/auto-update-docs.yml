name: Auto-Update Documentation

on:
  repository_dispatch:
    types: [source-pr-merged]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create prompt file
        run: |
          cat > /tmp/prompt.txt <<EOF
          A PR was just merged to the node-banana repository. Your task is to update this documentation site accordingly.

          ## Merged PR Details
          - PR #${{ github.event.client_payload.pr_number }}: ${{ github.event.client_payload.pr_title }}
          - URL: ${{ github.event.client_payload.pr_url }}
          - Description: ${{ github.event.client_payload.pr_body }}

          ## CRITICAL: Thoroughly Analyze the Actual Code Changes

          **DO NOT rely solely on the PR title and description.** PR descriptions are often incomplete or vague.
          You MUST fetch and analyze the actual code changes to identify ALL documentation-worthy updates.

          ### Step 1: Fetch the complete PR diff and changed files
          Run these commands to get the full picture:
          \`\`\`bash
          # Get list of all files changed in the PR
          gh pr view ${{ github.event.client_payload.pr_number }} --repo magicusername/node-banana --json files --jq '.files[].path'

          # Get the full diff of the PR
          gh pr diff ${{ github.event.client_payload.pr_number }} --repo magicusername/node-banana
          \`\`\`

          ### Step 2: Analyze each changed file for documentation-worthy content
          For each changed file, look for:
          - **New exports** - Any new function, class, constant, or type that is exported
          - **New parameters** - New options/parameters added to existing functions
          - **New node types** - Any additions to node definitions or registries
          - **Changed behavior** - Modified logic that affects how users interact with the library
          - **New dependencies** - Added packages that users might need to know about
          - **Configuration changes** - New config options or environment variables
          - **Breaking changes** - Removed or renamed exports, changed function signatures

          ### Step 3: Cross-reference with existing documentation
          Review the current docs pages to understand:
          - What's already documented (don't duplicate)
          - Where new features should be added (correct page/section)
          - Existing code examples that may need updates

          ## Documentation Update Guidelines

          1. **Changelog (pages/changelog.mdx)**: ALWAYS add an entry for code changes
             - Use the existing format (Added/Changed/Fixed/Removed)
             - Include PR number as reference
             - Keep entries succinct — one line per change, no sub-bullets
             - Good: "Prompt nodes can now receive text connections for LLM-to-Prompt chaining ([#38](url))"
             - Bad: A bold title followed by multiple nested bullets explaining implementation details
             - Focus on what changed from the user's perspective, not how it was implemented

          2. **Feature Documentation**: For new features, ensure they are documented in the appropriate page:
             - New node types → pages/nodes.mdx
             - New workflow capabilities → pages/first-workflow.mdx or pages/core-concepts.mdx
             - New utilities/helpers → pages/guides/best-practices.mdx
             - Installation changes → pages/installation.mdx

          3. **Code Examples**: If the PR includes new functionality, add working code examples showing how to use it

          ## Creating the Documentation PR

          After making changes:
          1. Create branch: docs/pr-${{ github.event.client_payload.pr_number }}
          2. Commit all changes with a descriptive message
          3. Push and create PR with title: docs: update for PR #${{ github.event.client_payload.pr_number }}
          4. In the PR body, list ALL changes you made and why

          ## When NOT to Update Documentation

          Only skip documentation updates for:
          - Pure internal refactoring with no public API changes
          - CI/CD pipeline changes
          - Test-only changes
          - README badge updates

          When in doubt, err on the side of documenting. Users should be able to discover ALL new features through the documentation.
          EOF

      - name: Run Claude Code CLI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx @anthropic-ai/claude-code -p "$(cat /tmp/prompt.txt)" --dangerously-skip-permissions --allowedTools "Bash,Read,Write,Edit,Glob,Grep"
